<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="" >

	<head>
		<meta charset="utf-8" />
		<meta name="generator" content="pandoc" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
										<title>Breaking The Verifier #2</title>
				<link rel="stylesheet" href="/home/cook/Computing/Blog/templates/styles.css" />
							</head>

	<body>
						<header id="title-block-header">
			<h1 class="title">Breaking The Verifier #2</h1>
											</header>
				<p>Breaking the verifier for all OpenJDK 8+ jvms by hooking shared library exports.</p>
    <!--more-->
    <p>Make sure you’ve read #1 before this so you have a basic understanding of what the verifier is and why it’s important.</p>
    <h2 id="some-background">Some background</h2>
    <p>Before Java 6, classes were verified in two stages:</p>
    <ul>
    <li>First, the type-inferencing verifier did type emulations of methods in order to predict the types of any values used</li>
    <li>Secondly, the type-checking verifier verified that types were used accurately</li>
    </ul>
    <p>A team working on the “Connected Limited Device Configuration” complained that this process, specifically the first stage, was slow and expensive to peform, paticularly on embedded systems. They proposed the split verifier.</p>
    <p>The split verifier has similar stages to the original verifier, except that the first stage is peformed at compile time, and embedded into the class file’s “StackMapTable” attributes by the compiler. This shifts the cost to compile time, potentially speeding up runtime class loading.</p>
    <p>The split verifier was initially intended to be shipped with Java 5 (Tiger release), but landed in Java 6, where the Java compiler had an optional experimental flag to generate the StackMapTable attributes, and the JVM would only use them if they were present.</p>
    <p>In Java 7 the StackMapTables were made mandatory for any version 7 class files, and the compiler produced them by default. However, to support older class files, the old verification method (now bundled externally in <code>verify.dll</code> or <code>libverify.so</code>) is used for any class files version 6 or less.</p>
    <h2 id="breaking-this">Breaking this</h2>
    <p>Lets take a look at the JVM code for loading the <code>verify</code> dynamic library that contains the split verifier</p>
    <p><a href="https://github.com/openjdk/jdk/blob/976acddeb5a8df1e868269787c023306aad3fe4a/src/hotspot/share/classfile/verifier.cpp#L66">verifier.cpp#L66</a>:</p>
    <div class="sourceCode" id="cb1"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Access to external entry for VerifyClassForMajorVersion - old byte code verifier</span></span>
    <span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></span>
    <span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">typedef</span> jboolean <span class="op">(*</span><span class="dt">verify_byte_codes_fn_t</span><span class="op">)(</span>JNIEnv <span class="op">*,</span> jclass<span class="op">,</span> <span class="dt">char</span> <span class="op">*,</span> jint<span class="op">,</span> jint<span class="op">);</span></span>
    <span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
    <span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="dt">verify_byte_codes_fn_t</span> <span class="at">volatile</span> _verify_byte_codes_fn <span class="op">=</span> NULL<span class="op">;</span></span>
    <span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="dt">verify_byte_codes_fn_t</span> verify_byte_codes_fn<span class="op">()</span> <span class="op">{</span></span>
    <span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>_verify_byte_codes_fn <span class="op">!=</span> NULL<span class="op">)</span></span>
    <span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _verify_byte_codes_fn<span class="op">;</span></span>
    <span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  MutexLocker locker<span class="op">(</span>Verify_lock<span class="op">);</span></span>
    <span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>_verify_byte_codes_fn <span class="op">!=</span> NULL<span class="op">)</span></span>
    <span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _verify_byte_codes_fn<span class="op">;</span></span>
    <span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Load verify dll</span></span>
    <span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> buffer<span class="op">[</span>JVM_MAXPATHLEN<span class="op">];</span></span>
    <span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> ebuf<span class="op">[</span><span class="dv">1024</span><span class="op">];</span></span>
    <span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>os<span class="op">::</span>dll_locate_lib<span class="op">(</span>buffer<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>buffer<span class="op">),</span> Arguments<span class="op">::</span>get_dll_dir<span class="op">(),</span> <span class="st">&quot;verify&quot;</span><span class="op">))</span></span>
    <span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NULL<span class="op">;</span> <span class="co">// Caller will throw VerifyError</span></span>
    <span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>lib_handle <span class="op">=</span> os<span class="op">::</span>dll_load<span class="op">(</span>buffer<span class="op">,</span> ebuf<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>ebuf<span class="op">));</span></span>
    <span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>lib_handle <span class="op">==</span> NULL<span class="op">)</span></span>
    <span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NULL<span class="op">;</span> <span class="co">// Caller will throw VerifyError</span></span>
    <span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>fn <span class="op">=</span> os<span class="op">::</span>dll_lookup<span class="op">(</span>lib_handle<span class="op">,</span> <span class="st">&quot;VerifyClassForMajorVersion&quot;</span><span class="op">);</span></span>
    <span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>fn <span class="op">==</span> NULL<span class="op">)</span></span>
    <span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NULL<span class="op">;</span> <span class="co">// Caller will throw VerifyError</span></span>
    <span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> _verify_byte_codes_fn <span class="op">=</span> CAST_TO_FN_PTR<span class="op">(</span><span class="dt">verify_byte_codes_fn_t</span><span class="op">,</span> fn<span class="op">);</span></span>
    <span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Quite simply, the JVM loads the <code>verify</code> library, then searches for the <code>VerifyClassForMajorVersion</code> function within it.</p>
    <p>How can we exploit this?</p>
    <p>We can:</p>
    <ol type="1">
    <li>Get a handle to the same library</li>
    <li>Find the same function</li>
    <li>Hook said function</li>
    </ol>
    <p>To implement this I will be using rust. Sources are included in <a href="https://github.com/x4e/Blog/blob/master/002-Breaking-The-Verifier-2/src/lib.rs">src/lib.rs</a>. I’ve only implemented this for linux but feel free to extend it to Windows. Should only require <code>dlopen</code> and <code>dlsym</code> being replaced with platform specific alternatives.</p>
    <p>First I need to find the folder where java will store its libraries. This is stored in the property <code>sun.boot.library.path</code>.</p>
    <div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> system<span class="op">:</span> jclass <span class="op">=</span> (<span class="op">**</span>env)<span class="op">.</span>FindClass<span class="op">.</span>unwrap()(env<span class="op">,</span> to_c_str(<span class="st">&quot;java/lang/System&quot;</span>))<span class="op">;</span></span>
    <span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> method<span class="op">:</span> jmethodID <span class="op">=</span> (<span class="op">**</span>env)<span class="op">.</span>GetStaticMethodID<span class="op">.</span>unwrap()(env<span class="op">,</span> system<span class="op">,</span> to_c_str(<span class="st">&quot;getProperty&quot;</span>)<span class="op">,</span> to_c_str(<span class="st">&quot;(Ljava/lang/String;)Ljava/lang/String;&quot;</span>))<span class="op">;</span></span>
    <span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> name<span class="op">:</span> jstring <span class="op">=</span> (<span class="op">**</span>env)<span class="op">.</span>NewStringUTF<span class="op">.</span>unwrap()(env<span class="op">,</span> to_c_str(<span class="st">&quot;sun.boot.library.path&quot;</span>))<span class="op">;</span></span>
    <span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> args<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>jvalue<span class="op">&gt;</span> <span class="op">=</span> <span class="pp">vec!</span>[jvalue <span class="op">{</span> l<span class="op">:</span> name <span class="op">};</span> <span class="dv">1</span>]<span class="op">;</span></span>
    <span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> out<span class="op">:</span> jstring <span class="op">=</span> (<span class="op">**</span>env)<span class="op">.</span>CallStaticObjectMethodA<span class="op">.</span>unwrap()(env<span class="op">,</span> system<span class="op">,</span> method<span class="op">,</span> args<span class="op">.</span>as_ptr())<span class="op">;</span></span>
    <span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="pp">assert!</span>(<span class="op">!</span>out<span class="op">.</span>is_null())<span class="op">;</span></span>
    <span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>PATH <span class="op">=</span> <span class="cn">Some</span>(from_c_str((<span class="op">**</span>env)<span class="op">.</span>GetStringUTFChars<span class="op">.</span>unwrap()(env<span class="op">,</span> out<span class="op">,</span> null_mut())))<span class="op">;</span></span></code></pre></div>
    <p>Now I can retrieve a handle to the <code>verify</code> dll:</p>
    <div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> dl<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">c_void</span> <span class="op">=</span> dlopen(to_c_str(<span class="pp">format!</span>(<span class="st">&quot;{}/libverify.so&quot;</span><span class="op">,</span> PATH<span class="op">.</span>clone()<span class="op">.</span>unwrap()))<span class="op">,</span> RTLD_LAZY)<span class="op">;</span></span></code></pre></div>
    <p>And then retrieve a pointer to the verify function:</p>
    <div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> symbol_ptr<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">c_void</span> <span class="op">=</span> dlsym(dl<span class="op">,</span> to_c_str(<span class="st">&quot;VerifyClassForMajorVersion&quot;</span>))<span class="op">;</span></span></code></pre></div>
    <p>Now I will use the <code>detour</code> crate to hook the method, this just modifies the function assembly to call my own function instead:</p>
    <div class="sourceCode" id="cb5"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">unsafe</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> dont_verify_lol(_env<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">c_void</span><span class="op">,</span> _class<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">c_void</span><span class="op">,</span> _buffer<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">c_char</span><span class="op">,</span> _len<span class="op">:</span> <span class="dt">c_int</span><span class="op">,</span> _major_version<span class="op">:</span> <span class="dt">c_int</span>) <span class="op">-&gt;</span> <span class="dt">c_uchar</span> <span class="op">{</span></span>
    <span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1 == class file is legal</span></span>
    <span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="dv">1</span><span class="op">;</span></span>
    <span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
    <span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> hook <span class="op">=</span> <span class="pp">RawDetour::</span>new(symbol_ptr <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> ()<span class="op">,</span> dont_verify_lol <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> ())</span>
    <span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>expect(<span class="st">&quot;target or source is not usable for detouring&quot;</span>)<span class="op">;</span></span>
    <span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>hook<span class="op">.</span>enable()<span class="op">.</span>expect(<span class="st">&quot;Couldn&#39;t enable hook&quot;</span>)<span class="op">;</span></span>
    <span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>HOOK <span class="op">=</span> <span class="cn">Some</span>(hook)<span class="op">;</span></span></code></pre></div>
    <p>And thats it… Now any class verified with the split verifier will instantly pass verification.</p>
    <p>You can test this by running <a href="https://github.com/x4e/Blog/blob/master/002-Breaking-The-Verifier-2/run.sh">run.sh</a>.</p>
    <h2 id="edit-1">Edit 1</h2>
    <p>As it turns out, this can be used to bypass verification on up to <strong>Java 7</strong> class files. That’s pretty big for obfuscators, as Java 7 still supports features like InvokeDynamic, and it is possible to convert Java 8 classes into Java 7.</p>
    <p>It turns out that the JVM is able to failover to the old split verifier if a class file (with a version &lt;=J7) fails the new verification</p>
    <p><a href="https://github.com/openjdk/jdk/blob/976acddeb5a8df1e868269787c023306aad3fe4a/src/hotspot/share/classfile/verifier.cpp#L194">verifier.cpp#L194</a></p>
    <div class="sourceCode" id="cb6"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>    ClassVerifier split_verifier<span class="op">(</span>klass<span class="op">,</span> THREAD<span class="op">);</span></span>
    <span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    split_verifier<span class="op">.</span>verify_class<span class="op">(</span>THREAD<span class="op">);</span></span>
    <span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    exception_name <span class="op">=</span> split_verifier<span class="op">.</span>result<span class="op">();</span></span>
    <span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    </span>
    <span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> can_failover <span class="op">=</span> <span class="op">!</span>DumpSharedSpaces <span class="op">&amp;&amp;</span></span>
    <span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>      klass<span class="op">-&gt;</span>major_version<span class="op">()</span> <span class="op">&lt;</span> NOFAILOVER_MAJOR_VERSION<span class="op">;</span></span>
    <span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>can_failover <span class="op">&amp;&amp;</span> <span class="op">!</span>HAS_PENDING_EXCEPTION <span class="op">&amp;&amp;</span>  <span class="co">// Split verifier doesn&#39;t set PENDING_EXCEPTION for failure</span></span>
    <span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>exception_name <span class="op">==</span> vmSymbols<span class="op">::</span>java_lang_VerifyError<span class="op">()</span> <span class="op">||</span></span>
    <span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>         exception_name <span class="op">==</span> vmSymbols<span class="op">::</span>java_lang_ClassFormatError<span class="op">()))</span> <span class="op">{</span></span>
    <span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      log_info<span class="op">(</span>verification<span class="op">)(</span><span class="st">&quot;Fail over class verification to old verifier for: </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> klass<span class="op">-&gt;</span>external_name<span class="op">());</span></span>
    <span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      log_info<span class="op">(</span><span class="kw">class</span><span class="op">,</span> init<span class="op">)(</span><span class="st">&quot;Fail over class verification to old verifier for: </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> klass<span class="op">-&gt;</span>external_name<span class="op">());</span></span>
    <span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>      message_buffer <span class="op">=</span> NEW_RESOURCE_ARRAY<span class="op">(</span><span class="dt">char</span><span class="op">,</span> message_buffer_len<span class="op">);</span></span>
    <span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>      exception_message <span class="op">=</span> message_buffer<span class="op">;</span></span>
    <span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      exception_name <span class="op">=</span> inference_verify<span class="op">(</span></span>
    <span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        klass<span class="op">,</span> message_buffer<span class="op">,</span> message_buffer_len<span class="op">,</span> THREAD<span class="op">);</span></span>
    <span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
    <span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>exception_name <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
    <span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>      exception_message <span class="op">=</span> split_verifier<span class="op">.</span>exception_message<span class="op">();</span></span>
    <span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
			</body>

</html>