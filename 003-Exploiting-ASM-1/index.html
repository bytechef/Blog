<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="" >

	<head>
		<meta charset="utf-8" />
		<meta name="generator" content="pandoc" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
										<title>Exploiting the OW2 ASM Library’s Parser</title>
				<link rel="stylesheet" href="/home/cook/Computing/Blog/templates/styles.css" />
							</head>

	<body>
						<header id="title-block-header">
			<h1 class="title">Exploiting the OW2 ASM Library’s Parser</h1>
											</header>
				<p>As an obfuscator developer it is my job to attempt to prevent reverse engineers from analyzing customer’s applications.</p>
    <p>One common tool used by Java reverse engineers is <a href="https://gitlab.ow2.org/asm/asm/">The OW2 ASM Library</a>, a library that can read, manipulate and write class files generated by the javac compiler. This makes ASM a target for obfuscation – hindering the functionality of ASM on obfuscated classes can be very valuable.</p>
    <p>In this post I’ll go over how I found and exploited a design flaw in the ASM library in order to create classfiles that render ASM useless.</p>
    <!--more-->
    <h2 id="well-known-attributes">Well Known Attributes</h2>
    <p>The JVM class file specification allows many structures to have attributes, for example fields and methods. These attributes are basically a section of bytes with a user defined name. For example, a custom attribute could be used to provide extra metadata to debuggers. Some attributes are “Well Known”, meaning that the name and structure of the attribute is known to and hardcoded within the JVM.</p>
    <p>An example of this is the <code>Code</code> attribute. When the JVM encounters an attribute within a method with the name <code>Code</code> it will be parsed according to <a href="https://docs.oracle.com/javase/specs/jvms/se15/html/jvms-4.html#jvms-4.7.3">the definition of the code attribute within the JVM specification</a>.</p>
    <p>What is interesting however is when a new Java release results in the addition of a new attribute. This happened in Java 11, when the introduction of Nest-Based Access Control (JEP 181: Allow separate classes to access each other’s private members) resulted in the <code>NestMembers</code> attribute being <a href="https://docs.oracle.com/javase/specs/jvms/se15/html/jvms-4.html#jvms-4.7.29">defined in the JVM specification</a>.</p>
    <p>There is an issue here – since compilers are allowed to insert user defined attributes into classfiles, what would happen if a Java 10 classfile with a custom <code>NestMembers</code> attribute is defined on a Java 11 virtual machine? Well luckily the JVM developers thought of this and the JVM will not parse a well known attribute if the classfile version is less than the version in which the attribute was defined.</p>
    <h2 id="the-exploit">The exploit</h2>
    <p>While the JVM developers took this issue into consideration, the ASM library developers did not. The library will always try to parse well known attributes, no matter the classfile version. What this means is that we could for example add an attribute with the name <code>NestMembers</code> and a length of 0 to a version 8 classfile. ASM would attempt to parse the NestMembers attribute and would basically buffer overflow as it attempts to read data from a 0 length attribute.</p>
    <p>I’ve written a example classfile to demonstrate this behaviour which can be viewed <a href="https://github.com/x4e/Blog/blob/master/003-Exploiting-ASM-1/Exploit.jcod">here</a>. The classfile simply prints “Hello World!” but the key part is the attribute defined at the bottom of it. Essentially this will run absolutely fine on any JVM, however ASM will crash upon attempting to parse the file with the following stacktrace:</p>
    <div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>java<span class="op">.</span><span class="fu">lang</span><span class="op">.</span><span class="fu">ArrayIndexOutOfBoundsException</span><span class="op">:</span> Index <span class="dv">317</span> out of bounds <span class="cf">for</span> length <span class="dv">317</span></span>
    <span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  at org<span class="op">.</span><span class="fu">objectweb</span><span class="op">.</span><span class="fu">asm</span><span class="op">.</span><span class="fu">ClassReader</span><span class="op">.</span><span class="fu">readUnsignedShort</span><span class="op">(</span>ClassReader<span class="op">.</span><span class="fu">java</span><span class="op">:</span><span class="dv">3561</span><span class="op">)</span></span>
    <span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  at org<span class="op">.</span><span class="fu">objectweb</span><span class="op">.</span><span class="fu">asm</span><span class="op">.</span><span class="fu">ClassReader</span><span class="op">.</span><span class="fu">accept</span><span class="op">(</span>ClassReader<span class="op">.</span><span class="fu">java</span><span class="op">:</span><span class="dv">660</span><span class="op">)</span></span>
    <span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  at org<span class="op">.</span><span class="fu">objectweb</span><span class="op">.</span><span class="fu">asm</span><span class="op">.</span><span class="fu">ClassReader</span><span class="op">.</span><span class="fu">accept</span><span class="op">(</span>ClassReader<span class="op">.</span><span class="fu">java</span><span class="op">:</span><span class="dv">394</span><span class="op">)</span></span></code></pre></div>
    <p>Looking at <a href="https://gitlab.ow2.org/asm/asm/-/blob/ASM_9_0/asm/src/main/java/org/objectweb/asm/ClassReader.java">the relevant code</a> we can see the fault:</p>
    <div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - The offset of the NestMembers attribute, or 0.</span></span>
    <span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> nestMembersOffset <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
    <span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">...</span></span>
    <span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> currentAttributeOffset <span class="op">=</span> <span class="fu">getFirstAttributeOffset</span><span class="op">();</span></span>
    <span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="fu">readUnsignedShort</span><span class="op">(</span>currentAttributeOffset <span class="op">-</span> <span class="dv">2</span><span class="op">);</span> i <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span> <span class="op">--</span>i<span class="op">)</span> <span class="op">{</span></span>
    <span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read the attribute_info&#39;s attribute_name and attribute_length fields.</span></span>
    <span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> attributeName <span class="op">=</span> <span class="fu">readUTF8</span><span class="op">(</span>currentAttributeOffset<span class="op">,</span> charBuffer<span class="op">);</span></span>
    <span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> attributeLength <span class="op">=</span> <span class="fu">readInt</span><span class="op">(</span>currentAttributeOffset <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
    <span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    currentAttributeOffset <span class="op">+=</span> <span class="dv">6</span><span class="op">;</span></span>
    <span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
    <span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>Constants<span class="op">.</span><span class="fu">SOURCE_FILE</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>attributeName<span class="op">))</span> <span class="op">{</span></span>
    <span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      sourceFile <span class="op">=</span> <span class="fu">readUTF8</span><span class="op">(</span>currentAttributeOffset<span class="op">,</span> charBuffer<span class="op">);</span></span>
    <span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">...</span></span>
    <span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>Constants<span class="op">.</span><span class="fu">NEST_MEMBERS</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>attributeName<span class="op">))</span> <span class="op">{</span></span>
    <span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>      nestMembersOffset <span class="op">=</span> currentAttributeOffset<span class="op">;</span></span>
    <span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">...</span></span>
    <span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
    <span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    currentAttributeOffset <span class="op">+=</span> attributeLength<span class="op">;</span></span>
    <span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
    <span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">...</span></span>
    <span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Visit the NestedMembers attribute.</span></span>
    <span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>nestMembersOffset <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
    <span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> numberOfNestMembers <span class="op">=</span> <span class="fu">readUnsignedShort</span><span class="op">(</span>nestMembersOffset<span class="op">);</span></span>
    <span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> currentNestMemberOffset <span class="op">=</span> nestMembersOffset <span class="op">+</span> <span class="dv">2</span><span class="op">;</span></span>
    <span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>numberOfNestMembers<span class="op">--</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
    <span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>      classVisitor<span class="op">.</span><span class="fu">visitNestMember</span><span class="op">(</span><span class="fu">readClass</span><span class="op">(</span>currentNestMemberOffset<span class="op">,</span> charBuffer<span class="op">));</span></span>
    <span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>      currentNestMemberOffset <span class="op">+=</span> <span class="dv">2</span><span class="op">;</span></span>
    <span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
    <span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
    <span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">...</span></span></code></pre></div>
    <p>The problem is easily visible here – the <code>NestMembers</code> attribute is always parsed if present, no matter the classfile version. This can be compared to the behaviour of <a href="https://github.com/openjdk/jdk/blob/0da9cad5f55713bc81f3a0689b8836ff548ad0cf/src/hotspot/share/classfile/classFileParser.cpp#L3715">the Open JDK’s classfile parser</a>, which clearly avoids this mistake with a <code>if (_major_version &gt;= JAVA_11_VERSION)</code>:</p>
    <div class="sourceCode" id="cb3"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Iterate over attributes</span></span>
    <span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>attributes_count<span class="op">--)</span> <span class="op">{</span></span>
    <span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    cfs<span class="op">-&gt;</span>guarantee_more<span class="op">(</span><span class="dv">6</span><span class="op">,</span> CHECK<span class="op">);</span>  <span class="co">// attribute_name_index, attribute_length</span></span>
    <span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> u2 attribute_name_index <span class="op">=</span> cfs<span class="op">-&gt;</span>get_u2_fast<span class="op">();</span></span>
    <span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> u4 attribute_length <span class="op">=</span> cfs<span class="op">-&gt;</span>get_u4_fast<span class="op">();</span></span>
    <span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    check_property<span class="op">(</span></span>
    <span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        valid_symbol_at<span class="op">(</span>attribute_name_index<span class="op">),</span></span>
    <span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Attribute name has bad constant pool index </span><span class="sc">%u</span><span class="st"> in class file </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span></span>
    <span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        attribute_name_index<span class="op">,</span> CHECK<span class="op">);</span></span>
    <span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Symbol<span class="op">*</span> <span class="at">const</span> tag <span class="op">=</span> cp<span class="op">-&gt;</span>symbol_at<span class="op">(</span>attribute_name_index<span class="op">);</span></span>
    <span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>tag <span class="op">==</span> vmSymbols<span class="op">::</span>tag_source_file<span class="op">())</span> <span class="op">{</span></span>
    <span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
    <span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>_major_version <span class="op">&gt;=</span> JAVA_11_VERSION<span class="op">)</span> <span class="op">{</span></span>
    <span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>tag <span class="op">==</span> vmSymbols<span class="op">::</span>tag_nest_members<span class="op">())</span> <span class="op">{</span></span>
    <span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check for NestMembers tag</span></span>
    <span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>parsed_nest_members_attribute<span class="op">)</span> <span class="op">{</span></span>
    <span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>          classfile_parse_error<span class="op">(</span><span class="st">&quot;Multiple NestMembers attributes in class file </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> THREAD<span class="op">);</span></span>
    <span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span><span class="op">;</span></span>
    <span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
    <span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>          parsed_nest_members_attribute <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
    <span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
    <span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>parsed_nest_host_attribute<span class="op">)</span> <span class="op">{</span></span>
    <span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>          classfile_parse_error<span class="op">(</span><span class="st">&quot;Conflicting NestHost and NestMembers attributes in class file </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> THREAD<span class="op">);</span></span>
    <span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span><span class="op">;</span></span>
    <span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
    <span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        nest_members_attribute_start <span class="op">=</span> cfs<span class="op">-&gt;</span>current<span class="op">();</span></span>
    <span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        nest_members_attribute_length <span class="op">=</span> attribute_length<span class="op">;</span></span>
    <span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        cfs<span class="op">-&gt;</span>skip_u1<span class="op">(</span>nest_members_attribute_length<span class="op">,</span> CHECK<span class="op">);</span></span>
    <span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>tag <span class="op">==</span> vmSymbols<span class="op">::</span>tag_nest_host<span class="op">())</span> <span class="op">{</span></span></code></pre></div>
    <p>I discovered this exploit while analysing ASM and included it within <a href="https://binclub.dev/binscure">my obfuscator</a> last year, however since it has now been copied by some of my competitors I thought it would be best to release it as a writeup. Hopefully this helps other people writing classfile parsers to know which pitfalls to avoid.</p>
			</body>

</html>